## DISABLE_FAST_SQL_PARSER
set TTL_DEBUG_USE_GSI_FOR_COLUMNAR_ARC_TBL = false
set TTL_DEBUG_CCI_SKIP_DDL_TASKS = "WaitColumnarTableAlterPartitionTask,WaitColumnarTableCreationTask"
set SKIP_DDL_TASKS="WaitColumnarTableAlterPartitionTask,WaitColumnarTableCreationTask"
set TTL_DEBUG_CURRENT_DATETIME='2024-06-27 00:00:00'
set TTL_FORBID_DROP_TTL_TBL_WITH_ARC_CCI = false
set time_zone='+08:00'
create table my_ttl_ts_t1(
a int not null auto_increment,
b timestamp default current_timestamp,
primary key(a)
)
partition by key(a) partitions 2
alter table my_ttl_ts_t1 modify ttl set TTL_ENABLE = 'OFF' TTL_EXPR = `b` EXPIRE AFTER 2 MONTH TIMEZONE '+08:00' TTL_JOB = CRON '* * */2 * * ?' TIMEZONE '+08:00' ARCHIVE_TABLE_PRE_ALLOCATE=5, ARCHIVE_TABLE_POST_ALLOCATE=3
show create table my_ttl_ts_t1
Table,Create Table
my_ttl_ts_t1,CREATE TABLE `my_ttl_ts_t1` (
	`a` int(11) NOT NULL AUTO_INCREMENT,
	`b` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY (`a`)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 TTL = TTL_DEFINITION( TTL_ENABLE = 'OFF', TTL_EXPR = `b` EXPIRE AFTER 2 MONTH TIMEZONE '+08:00', TTL_JOB = CRON '* * */2 * * ?' TIMEZONE '+08:00', ARCHIVE_TYPE = '', ARCHIVE_TABLE_NAME = '', ARCHIVE_TABLE_PRE_ALLOCATE = 5, ARCHIVE_TABLE_POST_ALLOCATE = 3 )
PARTITION BY KEY(`a`)
PARTITIONS 2
alter table my_ttl_ts_t1 modify ttl set ARCHIVE_TABLE_PRE_ALLOCATE = 3 ARCHIVE_TABLE_POST_ALLOCATE = 3
show create table my_ttl_ts_t1
Table,Create Table
my_ttl_ts_t1,CREATE TABLE `my_ttl_ts_t1` (
	`a` int(11) NOT NULL AUTO_INCREMENT,
	`b` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY (`a`)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 TTL = TTL_DEFINITION( TTL_ENABLE = 'OFF', TTL_EXPR = `b` EXPIRE AFTER 2 MONTH TIMEZONE '+08:00', TTL_JOB = CRON '* * */2 * * ?' TIMEZONE '+08:00', ARCHIVE_TYPE = '', ARCHIVE_TABLE_NAME = '', ARCHIVE_TABLE_PRE_ALLOCATE = 3, ARCHIVE_TABLE_POST_ALLOCATE = 3 )
PARTITION BY KEY(`a`)
PARTITIONS 2
create table my_arc_ts_t1 like my_ttl_ts_t1 ENGINE='COLUMNAR' ARCHIVE_MODE='TTL'
show create table my_ttl_ts_t1
Table,Create Table
my_ttl_ts_t1,CREATE TABLE `my_ttl_ts_t1` (
	`a` int(11) NOT NULL AUTO_INCREMENT,
	`b` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY (`a`),
	CLUSTERED COLUMNAR INDEX `arctmp_my_arc_ts_t1` (`b`)
		PARTITION BY RANGE(UNIX_TIMESTAMP(`b`))
		(PARTITION pstart VALUES LESS THAN (57600) ENGINE = Columnar,
		 PARTITION p202403 VALUES LESS THAN (1711900800) ENGINE = Columnar,
		 PARTITION p202404 VALUES LESS THAN (1714492800) ENGINE = Columnar,
		 PARTITION p202405 VALUES LESS THAN (1717171200) ENGINE = Columnar,
		 PARTITION p202406 VALUES LESS THAN (1719763200) ENGINE = Columnar,
		 PARTITION p202407 VALUES LESS THAN (1722441600) ENGINE = Columnar,
		 PARTITION p202408 VALUES LESS THAN (1725120000) ENGINE = Columnar,
		 PARTITION p202409 VALUES LESS THAN (1727712000) ENGINE = Columnar,
		 PARTITION pmax VALUES LESS THAN (MAXVALUE) ENGINE = Columnar)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 TTL = TTL_DEFINITION( TTL_ENABLE = 'OFF', TTL_EXPR = `b` EXPIRE AFTER 2 MONTH TIMEZONE '+08:00', TTL_JOB = CRON '* * */2 * * ?' TIMEZONE '+08:00', ARCHIVE_TYPE = 'COLUMNAR', ARCHIVE_TABLE_NAME = 'my_arc_ts_t1', ARCHIVE_TABLE_PRE_ALLOCATE = 3, ARCHIVE_TABLE_POST_ALLOCATE = 3 )
PARTITION BY KEY(`a`)
PARTITIONS 2
alter table my_ttl_ts_t1 modify ttl set ARCHIVE_TABLE_PRE_ALLOCATE = 4 ARCHIVE_TABLE_POST_ALLOCATE = 3
alter table my_ttl_ts_t1 cleanup expired data
show create table my_ttl_ts_t1
Table,Create Table
my_ttl_ts_t1,CREATE TABLE `my_ttl_ts_t1` (
	`a` int(11) NOT NULL AUTO_INCREMENT,
	`b` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY (`a`),
	CLUSTERED COLUMNAR INDEX `arctmp_my_arc_ts_t1` (`b`)
		PARTITION BY RANGE(UNIX_TIMESTAMP(`b`))
		(PARTITION pstart VALUES LESS THAN (57600) ENGINE = Columnar,
		 PARTITION p202403 VALUES LESS THAN (1711900800) ENGINE = Columnar,
		 PARTITION p202404 VALUES LESS THAN (1714492800) ENGINE = Columnar,
		 PARTITION p202405 VALUES LESS THAN (1717171200) ENGINE = Columnar,
		 PARTITION p202406 VALUES LESS THAN (1719763200) ENGINE = Columnar,
		 PARTITION p202407 VALUES LESS THAN (1722441600) ENGINE = Columnar,
		 PARTITION p202408 VALUES LESS THAN (1725120000) ENGINE = Columnar,
		 PARTITION p202409 VALUES LESS THAN (1727712000) ENGINE = Columnar,
		 PARTITION p202410 VALUES LESS THAN (1730390400) ENGINE = Columnar,
		 PARTITION pmax VALUES LESS THAN (MAXVALUE) ENGINE = Columnar)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 TTL = TTL_DEFINITION( TTL_ENABLE = 'OFF', TTL_EXPR = `b` EXPIRE AFTER 2 MONTH TIMEZONE '+08:00', TTL_JOB = CRON '* * */2 * * ?' TIMEZONE '+08:00', ARCHIVE_TYPE = 'COLUMNAR', ARCHIVE_TABLE_NAME = 'my_arc_ts_t1', ARCHIVE_TABLE_PRE_ALLOCATE = 4, ARCHIVE_TABLE_POST_ALLOCATE = 3 )
PARTITION BY KEY(`a`)
PARTITIONS 2
set time_zone='+08:00'
create table rng_dt (dt datetime)
PARTITION BY RANGE COLUMNS(`dt`)
(PARTITION pstart VALUES LESS THAN ('1970-01-02 00:00:00') ENGINE = InnoDB,
PARTITION p202403 VALUES LESS THAN ('2024-04-01 00:00:00') ENGINE = InnoDB,
PARTITION p202404 VALUES LESS THAN ('2024-05-01 00:00:00') ENGINE = InnoDB,
PARTITION p202405 VALUES LESS THAN ('2024-06-01 00:00:00') ENGINE = InnoDB,
PARTITION p202406 VALUES LESS THAN ('2024-07-01 00:00:00') ENGINE = InnoDB,
PARTITION p202407 VALUES LESS THAN ('2024-08-01 00:00:00') ENGINE = InnoDB,
PARTITION p202408 VALUES LESS THAN ('2024-09-01 00:00:00') ENGINE = InnoDB,
PARTITION p202409 VALUES LESS THAN ('2024-10-01 00:00:00') ENGINE = InnoDB)
show create table rng_dt
Table,Create Table
rng_dt,CREATE TABLE `rng_dt` (
	`dt` datetime DEFAULT NULL,
	KEY `auto_shard_key_dt` USING BTREE (`dt`)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4
PARTITION BY RANGE COLUMNS(`dt`)
(PARTITION pstart VALUES LESS THAN ('1970-01-02 00:00:00') ENGINE = InnoDB,
 PARTITION p202403 VALUES LESS THAN ('2024-04-01 00:00:00') ENGINE = InnoDB,
 PARTITION p202404 VALUES LESS THAN ('2024-05-01 00:00:00') ENGINE = InnoDB,
 PARTITION p202405 VALUES LESS THAN ('2024-06-01 00:00:00') ENGINE = InnoDB,
 PARTITION p202406 VALUES LESS THAN ('2024-07-01 00:00:00') ENGINE = InnoDB,
 PARTITION p202407 VALUES LESS THAN ('2024-08-01 00:00:00') ENGINE = InnoDB,
 PARTITION p202408 VALUES LESS THAN ('2024-09-01 00:00:00') ENGINE = InnoDB,
 PARTITION p202409 VALUES LESS THAN ('2024-10-01 00:00:00') ENGINE = InnoDB)
create table rng_ts (ts timestamp  default current_timestamp)
PARTITION BY RANGE(UNIX_TIMESTAMP(`ts`))
(PARTITION pstart VALUES LESS THAN (UNIX_TIMESTAMP('1970-01-02 00:00:00')) ENGINE = InnoDB,
PARTITION p202403 VALUES LESS THAN (UNIX_TIMESTAMP('2024-04-01 00:00:00')) ENGINE = InnoDB,
PARTITION p202404 VALUES LESS THAN (UNIX_TIMESTAMP('2024-05-01 00:00:00')) ENGINE = InnoDB,
PARTITION p202405 VALUES LESS THAN (UNIX_TIMESTAMP('2024-06-01 00:00:00')) ENGINE = InnoDB,
PARTITION p202406 VALUES LESS THAN (UNIX_TIMESTAMP('2024-07-01 00:00:00')) ENGINE = InnoDB,
PARTITION p202407 VALUES LESS THAN (UNIX_TIMESTAMP('2024-08-01 00:00:00')) ENGINE = InnoDB,
PARTITION p202408 VALUES LESS THAN (UNIX_TIMESTAMP('2024-09-01 00:00:00')) ENGINE = InnoDB,
PARTITION p202409 VALUES LESS THAN (UNIX_TIMESTAMP('2024-10-01 00:00:00')) ENGINE = InnoDB)
show create table rng_ts
Table,Create Table
rng_ts,CREATE TABLE `rng_ts` (
	`ts` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
	KEY `auto_shard_key_ts` USING BTREE (`ts`)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4
PARTITION BY RANGE(UNIX_TIMESTAMP(`ts`))
(PARTITION pstart VALUES LESS THAN (57600) ENGINE = InnoDB,
 PARTITION p202403 VALUES LESS THAN (1711900800) ENGINE = InnoDB,
 PARTITION p202404 VALUES LESS THAN (1714492800) ENGINE = InnoDB,
 PARTITION p202405 VALUES LESS THAN (1717171200) ENGINE = InnoDB,
 PARTITION p202406 VALUES LESS THAN (1719763200) ENGINE = InnoDB,
 PARTITION p202407 VALUES LESS THAN (1722441600) ENGINE = InnoDB,
 PARTITION p202408 VALUES LESS THAN (1725120000) ENGINE = InnoDB,
 PARTITION p202409 VALUES LESS THAN (1727712000) ENGINE = InnoDB)
set time_zone='+08:00'
select UNIX_TIMESTAMP('1970-01-02 00:00:00'), FROM_UNIXTIME(57600)
UNIX_TIMESTAMP('1970-01-02 00:00:00'),FROM_UNIXTIME(57600)
57600.0,1970-01-02 00:00:00.0
select UNIX_TIMESTAMP('2024-04-01 00:00:00'), FROM_UNIXTIME(1711900800)
UNIX_TIMESTAMP('2024-04-01 00:00:00'),FROM_UNIXTIME(1711900800)
1711900800,2024-04-01 00:00:00.0
select UNIX_TIMESTAMP('2024-05-01 00:00:00'), FROM_UNIXTIME(1714492800)
UNIX_TIMESTAMP('2024-05-01 00:00:00'),FROM_UNIXTIME(1714492800)
1714492800,2024-05-01 00:00:00.0
select UNIX_TIMESTAMP('2024-06-01 00:00:00'), FROM_UNIXTIME(1717171200)
UNIX_TIMESTAMP('2024-06-01 00:00:00'),FROM_UNIXTIME(1717171200)
1717171200,2024-06-01 00:00:00.0
select UNIX_TIMESTAMP('2024-07-01 00:00:00'), FROM_UNIXTIME(1719763200)
UNIX_TIMESTAMP('2024-07-01 00:00:00'),FROM_UNIXTIME(1719763200)
1719763200,2024-07-01 00:00:00.0
select UNIX_TIMESTAMP('2024-08-01 00:00:00'), FROM_UNIXTIME(1722441600)
UNIX_TIMESTAMP('2024-08-01 00:00:00'),FROM_UNIXTIME(1722441600)
1722441600,2024-08-01 00:00:00.0
select UNIX_TIMESTAMP('2024-09-01 00:00:00'), FROM_UNIXTIME(1725120000)
UNIX_TIMESTAMP('2024-09-01 00:00:00'),FROM_UNIXTIME(1725120000)
1725120000,2024-09-01 00:00:00.0
select UNIX_TIMESTAMP('2024-10-01 00:00:00'), FROM_UNIXTIME(1727712000)
UNIX_TIMESTAMP('2024-10-01 00:00:00'),FROM_UNIXTIME(1727712000)
1727712000,2024-10-01 00:00:00.0
select UNIX_TIMESTAMP('2024-11-01 00:00:00'), FROM_UNIXTIME(1730390400)
UNIX_TIMESTAMP('2024-11-01 00:00:00'),FROM_UNIXTIME(1730390400)
1730390400,2024-11-01 00:00:00.0
select UNIX_TIMESTAMP('2024-12-01 00:00:00'), FROM_UNIXTIME(1732982400)
UNIX_TIMESTAMP('2024-12-01 00:00:00'),FROM_UNIXTIME(1732982400)
1732982400,2024-12-01 00:00:00.0